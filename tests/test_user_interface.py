"""
–¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞ (–±–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥)
"""
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ src –≤ –ø—É—Ç—å
root_dir = Path(__file__).parent.parent
sys.path.insert(0, str(root_dir))
sys.path.insert(0, str(root_dir / "src"))


def test_user_interface():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...")

    try:
        from src.core.chat_manager import ChatManager

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä
        print("1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ChatManager...")
        chat_manager = ChatManager()
        print("‚úÖ ChatManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

        # –¢–µ—Å—Ç 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
        print("\n2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤...")
        test_queries = [
            "–†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç",
            "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –æ–±—É—á–µ–Ω–∏–µ?",
            "–ö–∞–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è?",
            "–ß–µ–º –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –ø—Ä–æ–≥—Ä–∞–º–º—ã?",
        ]

        for query in test_queries:
            print(f"–ó–∞–ø—Ä–æ—Å: '{query}'")
            response = chat_manager.handle_message("test_user_1", query)
            print(f"–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: {len(response)} —Å–∏–º–≤–æ–ª–æ–≤")
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
            if "—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å–∞—Ö" not in response:
                print("‚úÖ –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç")
            else:
                print("‚ö†Ô∏è –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç")

        # –¢–µ—Å—Ç 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—ç–∫–≥—Ä–∞—É–Ω–¥–∞
        print("\n3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ç–∫–≥—Ä–∞—É–Ω–¥–∞...")
        background = "–Ø backend-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ Python —Å –æ–ø—ã—Ç–æ–º 3 –≥–æ–¥–∞. –†–∞–±–æ—Ç–∞–ª —Å Django –∏ PostgreSQL. –ò–Ω—Ç–µ—Ä–µ—Å—É—é—Å—å –º–∞—à–∏–Ω–Ω—ã–º –æ–±—É—á–µ–Ω–∏–µ–º –∏ —Ö–æ—á—É —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –≤ —Å—Ç–æ—Ä–æ–Ω—É ML-–∏–Ω–∂–µ–Ω–µ—Ä–∞."

        response = chat_manager.set_user_background("test_user_2", background)
        print("‚úÖ –ë—ç–∫–≥—Ä–∞—É–Ω–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω")

        # –¢–µ—Å—Ç 3: –ó–∞–ø—Ä–æ—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
        print("\n4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π...")
        recommendation_queries = [
            "–ü–æ—Å–æ–≤–µ—Ç—É–π –º–Ω–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã",
            "–ö–∞–∫—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –≤—ã–±—Ä–∞—Ç—å?",
            "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–±—É—á–µ–Ω–∏—é",
            "–ß—Ç–æ –∏–∑—É—á–∞—Ç—å?",
        ]

        for query in recommendation_queries:
            print(f"–ó–∞–ø—Ä–æ—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: '{query}'")
            response = chat_manager.handle_message("test_user_2", query)

            if "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" in response or "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" in response.lower():
                print("‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã")
            elif "—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å–∞—Ö" in response:
                print("‚ö†Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª –∑–∞–ø—Ä–æ—Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π")
            else:
                print("‚úÖ –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç")

        # –¢–µ—Å—Ç 4: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ—Å—Ç—å –¥–∏–∞–ª–æ–≥–∞
        print("\n5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∞...")
        user_id = "test_user_3"

        # –ó–∞–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        chat_manager.handle_message(user_id, "–†–∞—Å—Å–∫–∞–∂–∏ –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç")

        # –ó–∞–¥–∞–µ–º —É—Ç–æ—á–Ω—è—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        response = chat_manager.handle_message(user_id, "–ê —Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç?")
        print(f"–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: {len(response)} —Å–∏–º–≤–æ–ª–æ–≤")

        if "—Å—Ç–æ–∏–º–æ—Å—Ç—å" in response.lower() or "‚ÇΩ" in response:
            print("‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —É—á—Ç–µ–Ω")
        else:
            print("‚ö†Ô∏è –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ —É—á—Ç–µ–Ω")

        # –¢–µ—Å—Ç 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        print("\n6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤...")
        irrelevant_queries = [
            "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ —Å–µ–≥–æ–¥–Ω—è?",
            "–ö–∞–∫ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –±–æ—Ä—â?",
            "–†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç",
        ]

        for query in irrelevant_queries:
            response = chat_manager.handle_message("test_user_4", query)
            if "—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å–∞—Ö" in response:
                print(f"‚úÖ –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω: '{query}'")
            else:
                print(f"‚ö†Ô∏è –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø—Ä–æ–ø—É—â–µ–Ω: '{query}'")

        print("\nüéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")

        # –ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ RAG
        try:
            rag_stats = chat_manager.data_loader.get_rag_stats()
            print(f"\nüìä RAG —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: {rag_stats['status']}")
            if rag_stats['status'] == 'ready':
                print(f"–í—Å–µ–≥–æ —á–∞–Ω–∫–æ–≤: {rag_stats.get('total_chunks', 0)}")

        except Exception as e:
            print(f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ RAG –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")

        return True

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    test_user_interface()
